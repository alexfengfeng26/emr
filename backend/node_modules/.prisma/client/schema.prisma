// Prisma数据库模型定义
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// 用户表
model User {
  id         Int        @id @default(autoincrement())
  username   String     @unique @db.VarChar(50)
  password   String     @db.VarChar(255)
  name       String     @db.VarChar(100)
  email      String?    @unique @db.VarChar(100)
  phone      String?    @db.VarChar(20)
  role       UserRole   @default(DOCTOR)
  department String?    @db.VarChar(100)
  avatar     String?    @db.VarChar(255)
  status     UserStatus @default(ACTIVE)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  // 关联关系
  medicalRecords        MedicalRecord[]
  medicalOrders         MedicalOrder[]
  requestedExaminations Examination[]   @relation("ExaminationRequestedBy")
  reportedExaminations  Examination[]   @relation("ExaminationReportedBy")
  auditLogs             AuditLog[]

  @@map("users")
}

// 患者表
model Patient {
  id               Int           @id @default(autoincrement())
  name             String        @db.VarChar(100)
  gender           Gender
  birthDate        DateTime
  idCard           String?       @unique @db.VarChar(18)
  phone            String?       @db.VarChar(20)
  address          String?       @db.Text
  emergencyContact String?       @db.VarChar(100)
  emergencyPhone   String?       @db.VarChar(20)
  bloodType        BloodType?
  allergies        String?       @db.Text
  medicalHistory   String?       @db.Text
  status           PatientStatus @default(ACTIVE)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // 关联关系
  medicalRecords MedicalRecord[]
  medicalOrders  MedicalOrder[]
  examinations   Examination[]

  @@map("patients")
}

// 病历表
model MedicalRecord {
  id           Int                 @id @default(autoincrement())
  patientId    Int
  doctorId     Int
  type         MedicalRecordType
  title        String              @db.VarChar(200)
  content      String              @db.Text
  diagnosis    String?             @db.Text
  treatment    String?             @db.Text
  prescription String?             @db.Text
  attachments  String?             @db.Text // JSON格式存储附件信息
  version      Int                 @default(1)
  status       MedicalRecordStatus @default(DRAFT)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  // 关联关系
  patient Patient @relation(fields: [patientId], references: [id])
  doctor  User    @relation(fields: [doctorId], references: [id])

  @@index([patientId])
  @@index([doctorId])
  @@index([createdAt])
  @@map("medical_records")
}

// 医嘱表
model MedicalOrder {
  id         Int              @id @default(autoincrement())
  patientId  Int
  doctorId   Int
  orderType  MedicalOrderType
  content    String           @db.Text
  dosage     String?          @db.VarChar(200)
  frequency  String?          @db.VarChar(100)
  duration   String?          @db.VarChar(100)
  priority   OrderPriority    @default(NORMAL)
  status     OrderStatus      @default(PENDING)
  executedAt DateTime?
  executedBy Int?
  notes      String?          @db.Text
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  // 关联关系
  patient Patient @relation(fields: [patientId], references: [id])
  doctor  User    @relation(fields: [doctorId], references: [id])

  @@index([patientId])
  @@index([doctorId])
  @@index([status])
  @@index([createdAt])
  @@map("medical_orders")
}

// 检查检验表
model Examination {
  id          Int               @id @default(autoincrement())
  patientId   Int
  examType    ExaminationType
  examName    String            @db.VarChar(200)
  description String?           @db.Text
  result      String?           @db.Text
  reportUrl   String?           @db.VarChar(500)
  images      String?           @db.Text // JSON格式存储影像信息
  status      ExaminationStatus @default(PENDING)
  requestedBy Int
  reportedBy  Int?
  reportedAt  DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // 关联关系
  patient   Patient @relation(fields: [patientId], references: [id])
  requester User    @relation("ExaminationRequestedBy", fields: [requestedBy], references: [id])
  reporter  User?   @relation("ExaminationReportedBy", fields: [reportedBy], references: [id])

  @@index([patientId])
  @@index([examType])
  @@index([status])
  @@index([createdAt])
  @@map("examinations")
}

// 系统配置表
model SystemConfig {
  id          Int      @id @default(autoincrement())
  key         String   @unique @db.VarChar(100)
  value       String   @db.Text
  description String?  @db.VarChar(255)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("system_configs")
}

// 审计日志表
model AuditLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  action    String   @db.VarChar(100)
  resource  String?  @db.VarChar(200)
  details   String?  @db.Text
  ip        String?  @db.VarChar(45)
  userAgent String?  @db.Text
  result    String   @default("success") @db.VarChar(20)
  createdAt DateTime @default(now())

  // 关联关系
  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// 枚举定义
enum UserRole {
  ADMIN
  DOCTOR
  NURSE
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum Gender {
  MALE
  FEMALE
}

enum BloodType {
  A
  B
  AB
  O
}

enum PatientStatus {
  ACTIVE
  DISCHARGED
  TRANSFERRED
  DECEASED
}

enum MedicalRecordType {
  OUTPATIENT // 门诊病历
  INPATIENT // 住院病历
  EMERGENCY // 急诊病历
  SURGERY // 手术记录
  DISCHARGE // 出院记录
  CONSULTATION // 会诊记录
}

enum MedicalRecordStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

enum MedicalOrderType {
  MEDICATION // 药物医嘱
  EXAMINATION // 检查医嘱
  LABORATORY // 检验医嘱
  TREATMENT // 治疗医嘱
  NURSING // 护理医嘱
  DIET // 饮食医嘱
}

enum OrderPriority {
  LOW
  NORMAL
  HIGH
  URGENT
  STAT
}

enum OrderStatus {
  PENDING
  APPROVED
  EXECUTED
  CANCELLED
  SUSPENDED
}

enum ExaminationType {
  LABORATORY // 实验室检查
  RADIOLOGY // 影像检查
  PATHOLOGY // 病理检查
  FUNCTION // 功能检查
  ENDOSCOPY // 内镜检查
  ULTRASOUND // 超声检查
  ECG // 心电图
  EEG // 脑电图
}

enum ExaminationStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}
